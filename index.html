<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>La Mia Watchlist</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #0f172a; }
        
        /* Custom Scrollbar Styling - Ora visibile e funzionante */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #38bdf8; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #0ea5e9; }

        /* Accordion Animation */
        .accordion-content { transition: max-height 0.3s ease-in-out, opacity 0.3s ease-in-out; max-height: 0; opacity: 0; overflow: hidden; }
        .accordion-content.open { max-height: 2000px; opacity: 1; }
        
        .chevron { transition: transform 0.3s; }
        .group[data-open="true"] .chevron { transform: rotate(180deg); }
    </style>
</head>
<body class="text-slate-200 font-sans antialiased selection:bg-sky-500 selection:text-white pb-20">

    <div id="cache-warning" class="bg-yellow-600/20 border-b border-yellow-600/50 text-yellow-200 px-4 py-2 text-center text-sm font-mono cursor-pointer hover:bg-yellow-600/30 transition">
        ⚠️ Non vedi le modifiche? Premi <strong>CTRL + SHIFT + R</strong> per aggiornare. <span onclick="this.parentElement.remove()" class="underline ml-2 text-yellow-400">Chiudi</span>
    </div>

    <nav class="sticky top-0 z-40 bg-slate-900/95 backdrop-blur-md border-b border-slate-700 p-4 shadow-xl">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <h1 class="text-2xl font-bold bg-gradient-to-r from-sky-400 to-indigo-400 bg-clip-text text-transparent">
                MyWatchlist <span class="text-slate-500 text-sm font-mono ml-2"></span>
            </h1>
            <div class="text-xs text-slate-400 font-mono hidden sm:block">Total items: <span id="total-count">0</span></div>
        </div>
    </nav>

    <main id="main-container" class="max-w-6xl mx-auto p-4 space-y-4 mt-6">
        </main>

    <div id="movie-modal" class="fixed inset-0 z-50 hidden items-center justify-center p-4 bg-black/95 backdrop-blur-sm transition-opacity" onclick="if(event.target===this) closeModal()">
        <div class="bg-slate-800 rounded-2xl max-w-5xl w-full overflow-hidden shadow-2xl border border-slate-700 relative flex flex-col md:flex-row max-h-[90vh]">
            <button onclick="closeModal()" class="absolute top-3 right-3 z-10 p-2 bg-black/60 rounded-full text-white hover:bg-red-500 transition">✕</button>
            
            <div class="w-full md:w-2/3 bg-black aspect-video md:aspect-auto relative">
                <iframe id="modal-trailer" class="absolute inset-0 w-full h-full" src="" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>
            </div>

            <div class="w-full md:w-1/3 p-6 md:p-8 flex flex-col bg-slate-800 overflow-y-auto">
                <span id="modal-category" class="text-xs font-bold text-sky-400 uppercase tracking-widest mb-2"></span>
                <h2 id="modal-title" class="text-2xl md:text-3xl font-extrabold text-white leading-tight mb-2"></h2>
                
                <div class="flex items-center space-x-4 text-sm text-slate-400 mb-6 border-b border-slate-700 pb-4">
                    <span class="flex items-center">⏱ <span id="modal-duration" class="ml-1 text-slate-200"></span></span>
                </div>
                
                <p id="modal-plot" class="text-slate-300 leading-relaxed text-sm mb-6 flex-grow"></p>
                
                <div class="mt-auto pt-4">
                    <a id="modal-justwatch" href="#" target="_blank" class="flex items-center justify-center w-full gap-2 bg-[#fbc500] hover:bg-[#e0b000] text-black font-bold py-3 px-4 rounded-lg transition-transform hover:scale-[1.02] shadow-lg">
                        <img src="https://www.justwatch.com/appassets/img/logo/JustWatch-logo-large.webp" alt="JW" class="h-4 w-auto object-contain brightness-0"> 
                        <span>Trova streaming</span>
                    </a>
                    <p class="text-[10px] text-center text-slate-500 mt-2">Verifica su Netflix, Prime, Disney+ etc.</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const categoryOrder = ["Film - Horror", "Film", "Film - Thriller", "Cartoni", "Serie TV", "Serie TV animate", "MCU", "DCU"];

        // Funzione Smart per estrarre l'ID da qualsiasi link YouTube
        function getYouTubeId(url) {
            if (!url || url === 'placeholder') return null;
            if (url.length === 11) return url;
            const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
            const match = url.match(regExp);
            return (match && match[2].length === 11) ? match[2] : null;
        }

        async function loadMovies() {
            try {
                const response = await fetch('movies.json?v=' + new Date().getTime());
                const movies = await response.json();
                renderAccordion(movies);
                document.getElementById('total-count').innerText = movies.length;
            } catch (error) {
                console.error("Errore:", error);
                document.getElementById('main-container').innerHTML = "<div class='text-center text-red-400 p-10 border border-red-800 rounded bg-red-900/20'>Errore caricamento dati. Verifica il JSON.</div>";
            }
        }

        function renderAccordion(movies) {
            const container = document.getElementById('main-container');
            container.innerHTML = '';

            categoryOrder.forEach((catName, index) => {
                const catMovies = movies.filter(m => m.category === catName);
                if (catMovies.length === 0) return;

                const section = document.createElement('div');
                section.className = "group border border-slate-700 rounded-xl bg-slate-800/50 overflow-hidden mb-6";
                section.dataset.open = index === 0 ? "true" : "false";

                const header = document.createElement('div');
                header.className = "p-4 flex items-center justify-between cursor-pointer hover:bg-slate-700/50 transition select-none z-10 relative bg-slate-800";
                header.onclick = () => toggleSection(section);
                header.innerHTML = `
                    <div class="flex items-center gap-3">
                        <span class="w-2 h-2 rounded-full bg-sky-500 shadow-[0_0_10px_rgba(14,165,233,0.5)]"></span>
                        <h2 class="text-lg font-bold text-slate-100">${catName}</h2>
                        <span class="text-xs bg-slate-900 text-slate-400 px-2 py-0.5 rounded-full border border-slate-700">${catMovies.length}</span>
                    </div>
                    <svg class="chevron w-5 h-5 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                    </svg>
                `;

                const contentWrapper = document.createElement('div');
                contentWrapper.className = `accordion-content ${index === 0 ? 'open' : ''}`;
                
                const scrollContainer = document.createElement('div');
                // NOTA: Ho rimosso 'no-scrollbar' qui sotto come richiesto per far vedere la barra
                scrollContainer.className = "flex overflow-x-auto gap-4 p-4 pb-6 snap-x";
                
                catMovies.forEach(movie => {
                    const card = document.createElement('div');
                    card.className = "flex-none w-[140px] md:w-[180px] group/card relative bg-slate-900 rounded-lg overflow-hidden cursor-pointer hover:scale-105 transition-all duration-300 shadow-lg aspect-[2/3] snap-start border border-slate-700/50";
                    card.onclick = () => openModal(movie);

                    card.innerHTML = `
                        <img src="${movie.cover}" alt="${movie.title}" loading="lazy" class="w-full h-full object-cover opacity-90 group-hover/card:opacity-100 transition-opacity">
                        <div class="absolute inset-0 bg-gradient-to-t from-slate-900 via-transparent to-transparent opacity-80"></div>
                        <div class="absolute bottom-0 left-0 right-0 p-3">
                            <h3 class="font-semibold text-xs text-white truncate shadow-black drop-shadow-md">${movie.title}</h3>
                            <p class="text-[10px] text-sky-400 mt-0.5">${movie.duration}</p>
                        </div>
                    `;
                    scrollContainer.appendChild(card);
                });

                contentWrapper.appendChild(scrollContainer);
                section.appendChild(header);
                section.appendChild(contentWrapper);
                container.appendChild(section);
            });
        }

        function toggleSection(section) {
            const content = section.querySelector('.accordion-content');
            const isOpen = section.dataset.open === "true";
            
            if (isOpen) {
                content.classList.remove('open');
                section.dataset.open = "false";
            } else {
                content.classList.add('open');
                section.dataset.open = "true";
            }
        }

        // Modal Logic
        const modal = document.getElementById('movie-modal');
        const els = { 
            title: document.getElementById('modal-title'), 
            plot: document.getElementById('modal-plot'), 
            cat: document.getElementById('modal-category'), 
            dur: document.getElementById('modal-duration'), 
            video: document.getElementById('modal-trailer'),
            jwBtn: document.getElementById('modal-justwatch') // Nuovo riferimento al bottone
        };

        function openModal(movie) {
            els.title.innerText = movie.title;
            els.plot.innerText = movie.plot || "Nessuna trama disponibile.";
            els.cat.innerText = movie.category;
            els.dur.innerText = movie.duration;
            
            // 1. GESTIONE VIDEO YOUTUBE
            const videoId = getYouTubeId(movie.trailer);
            if (videoId) {
                els.video.src = `https://www.youtube.com/embed/${videoId}?autoplay=1`;
            } else {
                els.video.src = '';
            }

            // 2. GESTIONE JUSTWATCH LINK (Generazione Dinamica)
            // Crea un link di ricerca: https://www.justwatch.com/it/cerca?q=NomeFilm
            const searchTitle = encodeURIComponent(movie.title);
            els.jwBtn.href = `https://www.justwatch.com/it/cerca?q=${searchTitle}`;

            modal.classList.remove('hidden');
            modal.classList.add('flex');
            document.body.style.overflow = 'hidden';
        }

        function closeModal() {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            els.video.src = ''; 
            document.body.style.overflow = '';
        }

        loadMovies();
    </script>
</body>
</html>


